#!/usr/bin/env bash

subcommand="$1"

if test "$subcommand" == "run"; then
  # The script name is the first non-flag after `run`.
  script=''
  index=2
  for arg in "${@:index}"; do
    ((index++))
    if test "${arg:0:1}" != '-'; then
      script="$arg"
      break
    fi
  done

  if test -n "$script"; then
    package="$(look-up 'package.json')"

    if test -n "$package"; then
      content="$(node -p 'try { require(process.argv[1]).scripts[process.argv[2]] || "" } catch (e) { "" }' "$package" "$script")"

      # Command not found. Let the regular `npm run` die with its nice error message.
      if test -z "$content"; then
        nodev look-up npm run "$script"
      fi

      # Everything after the script name, except `--`.
      args=()
      for arg in "${@:index}"; do
        if test "$arg" != "--"; then
          args+=("$(printf '%q' "$arg")") # Escape arg (just for display reasons).
        fi
      done

      # Print the script name and command that actually runs, in different
      # colors.
      >&2 printf '\e[38;5;239m%s\t\e[38;5;243m%s %s\e[0m\n' "$script" "$content" "${args[*]}"
    fi
  fi
fi

nodev look-up npm "$@"
